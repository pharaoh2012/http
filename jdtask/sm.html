<!DOCTYPE HTML>
<html lang="zh-cn"  manifest = "sm.manifest">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>京东收藏领豆</title>
    <style type="text/css">
        .visited {
            color: gray;
        }
    </style>
</head>

<body>
    <div id="main">

    </div>
    <script src="js/jquery.min.js"></script>
    <script>
        var clickedUrl = localStorage.getItem("smJdClickUrl");
        if (clickedUrl) {
            clickedUrl = JSON.parse(clickedUrl);
        } else {
            clickedUrl = [];
        }
        (function () {
            var loadTime = localStorage.getItem("smJdLoadTime");
            if (!loadTime) loadTime = 0;
            var now = +new Date();
            var needLoad = (now - loadTime > 5 * 60000);
            if (needLoad) {
                $("#main").html('loading...<br />' + localStorage.getItem("smJdHtml"));
                setClicked();
                $.get("https://getpage.now.sh/?url=https%3A%2F%2Fshimo.im%2Fdocs%2Fb4LMFBapNUMp07ym%2Fread", r => {
                    //console.info(r);
                    var txt =
                        '<p>取消店铺关注<a href="https://u.jd.com/D4jTCn" target="_blank" rel="noopener noreferrer nofollow">https://u.jd.com/D4jTCn</a></p>' +
                        $(r).find(".ql-editor").html();
                    localStorage.setItem("smJdHtml", txt);
                    $("#main").html(txt);
                    setClicked();
                    localStorage.setItem("smJdLoadTime", now);
                });
            } else {
                $("#main").html('缓存<br />' + localStorage.getItem("smJdHtml"));
                setClicked();
            }
        })();

        $(document.body).on("click", "a.ql-link", e => {
            var href = e.target.href;
            if (clickedUrl.indexOf(href) == -1) {
                e.target.className = "ql-link visited";
                clickedUrl.push(href);
                if (clickedUrl.length > 50) clickedUrl.pop();
                localStorage.setItem("smJdClickUrl", JSON.stringify(clickedUrl));
            }
            open(href);
            return false;
        });

        function setClicked() {
            var $a = $("a.ql-link");
            var l = 100;
            if ($a.length < 100) l = $a.length;
            for (let index = 0; index < l; index++) {
                var a = $a[index];
                if (clickedUrl.indexOf(a.href) >= 0) {
                    a.className = "ql-link visited";
                }
            }
        }
    </script>
</body>

</html>