<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>学习强国登录二维码</title>
	<style>
		html,
		body,
		iframe {
			width: 100%;
			height: 100%;
			padding: 0;
			margin: 10px;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<div id="time"></div>
	<iframe id="qrcode" src="about:blank" frameborder="0"></iframe>
	<script>
		fetch("https://geturl.pharaoh.workers.dev/--------https://nodejsweb-20190905.appspot.com/api/xuexiqrcode").then(r => r.json()).then(js => {
			console.info(js);
			let url = js.subject;
			let u = getLongUrl(url,lurl=>{
				document.getElementById('qrcode').src = lurl;
			});
			//document.getElementById('qrcode').src = js.subject;

			let dt = new Date(js._id);
			document.getElementById("time").innerText = dt.toLocaleString();
		})
		function getLongUrl(url,cb) {
			var ajax = new XMLHttpRequest();
			var token = '4a0675ddd0b4258a63f61c6ca314d693';
			var shortUrl = url;

			ajax.open('post', 'https://dwz.cn/admin/v2/query', 'true');

			ajax.setRequestHeader("Content-Type", "application/json");
			ajax.setRequestHeader("Token", token);
			// 发送请求
			ajax.send(JSON.stringify({
				shortUrl: shortUrl
			}));

			ajax.onreadystatechange = function () {
				if (ajax.readyState === 4 && ajax.status === 200) {
					// 短网址对应的长网址
					let json = JSON.parse(ajax.responseText);
					cb(json.LongUrl);
					console.log(ajax.responseText);
				}
			}
		}
	</script>

</body>

</html>